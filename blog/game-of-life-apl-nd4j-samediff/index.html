<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Implementing Conway’s Game of Life with Tensor Math &#8211; dubs·tech</title>
<meta name="description" content="Exploring the similarities between APL and tensor math libraries.">
<meta name="keywords" content="apl, nd4j, samediff">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@dot_treo">
<meta name="twitter:creator" content="@dot_treo">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Implementing Conway’s Game of Life with Tensor Math">
<meta property="og:description" content="Exploring the similarities between APL and tensor math libraries.">
<meta property="og:url" content="https://www.dubs.tech/blog/game-of-life-apl-nd4j-samediff/">
<meta property="og:site_name" content="dubs·tech">
<meta property="og:image" content="https://www.dubs.tech/images/images/logo.png">

<meta name="google-site-verification" content="n-ohWAcyARq2F3YAT0UtBa3gh0fluEoFMmHupOCXOvs">



<link rel="canonical" href="https://www.dubs.tech/blog/game-of-life-apl-nd4j-samediff/">
<link href="https://www.dubs.tech/feed.xml" type="application/atom+xml" rel="alternate" title="dubs·tech Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="https://www.dubs.tech/assets/css/main.css">
<link rel="stylesheet" href="https://www.dubs.tech/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="https://www.dubs.tech/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script type="text/javascript" src="https://www.dubs.tech/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://www.dubs.tech/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://www.dubs.tech/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://www.dubs.tech/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.dubs.tech/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.dubs.tech/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.dubs.tech/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><h2><i class="fa fa-bars"></i></h2></a></li>
      <li class="header-item-title">
        <a href="https://www.dubs.tech/">
          
            <img class="logo" src="https://www.dubs.tech/images/logo.png" alt="dubs·tech">
          
          <a href="https://www.dubs.tech/" class="title"> dubs·tech</a>
        </a>
      </li>
      
        
        

        
          <li class="header-item "><a href="https://www.dubs.tech/categories"><h3>Categories</h3></a>
            <ul class="header-submenu">
              
                
                  <li class="sub-item"><a href="https://www.dubs.tech/categories/#blog">blog</a></li>
              
                
                  <li class="sub-item"><a href="https://www.dubs.tech/categories/#guides">guides</a></li>
              
            </ul>
          </li>
        
      
        
        

        
            
                <li class="header-item "><a href="https://www.dubs.tech/tags"><h3>Tags</h3></a></li>
            
        
      
        
        

        
            
                <li class="header-item "><a href="https://www.dubs.tech/"><h3>Home</h3></a></li>
            
        
      
      <li class="header-item"><a href="https://www.dubs.tech/search"><h3><i class="fa fa-search"></i></h3></a></li>
    </ul>
  </div>
<div class="entry-header">
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Implementing Conway’s Game of Life with Tensor Math</h1>
      
        <h2><span class="entry-date date published updated"><time datetime="2018-02-23T09:28:40+01:00">February 23, 2018</time></span></h2>
      

      
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~18 minutes
        </p><!-- /.entry-reading-time -->
      
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->


<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="https://www.dubs.tech/"><h3>Home</h3></a></li>
      
    
      
        <li><a href="https://www.dubs.tech/tags"><h3>Tags</h3></a></li>
      
    
      
        <li><a href="https://www.dubs.tech/categories"><h3>Categories</h3></a>
          <ul>
            
              
                <li><a href="https://www.dubs.tech/categories/#blog">blog</a></li>
            
              
                <li><a href="https://www.dubs.tech/categories/#guides">guides</a></li>
            
          </ul>
        </li>
      
    
  </ul>
</nav>

<div id="main" role="main">
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">Implementing Conway’s Game of Life with Tensor Math</h1>
      <p>Conway’s Game of Life is a simple simulation that works on a two-dimensional plane. It has just a few very simple rules:</p>

<ul>
  <li>An empty cell that has exactly 3 neighbors will be populated in the next timestep</li>
  <li>A populated cell requires either 2 or 3 neighbors to stay populated, i.e. it will be unpopulated in the next timestep for any other case.</li>
</ul>

<p>There are a lot of different ways to implement those rules. This post first looks at a solution in a quite unusual language, namely APL, before showing how to do the same thing using the Java tensor math library ND4J and its upcoming graph variant SameDiff. 
<!--more--></p>

<p>As this is a pretty long post, and you might want to refer to some parts of it directly, you can use this table of contents to do so.</p>
<ul id="markdown-toc">
  <li><a href="#apl" id="markdown-toc-apl">APL</a></li>
  <li><a href="#conways-game-of-life-in-apl" id="markdown-toc-conways-game-of-life-in-apl">Conway’s Game of Life in APL</a></li>
  <li><a href="#conways-game-of-life-in-java-with-nd4j" id="markdown-toc-conways-game-of-life-in-java-with-nd4j">Conway’s Game of Life in Java with ND4J</a></li>
  <li><a href="#conways-game-of-life-in-java-with-samediff" id="markdown-toc-conways-game-of-life-in-java-with-samediff">Conway’s Game of Life in Java with SameDiff</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<h2 id="apl">APL</h2>
<p>APL is an array-oriented programming language. It has its origin as a notation for (mathematical) thought. The abbreviation APL means literally “A Programming Language”, but has later also taken on the meaning of “Array Processing Language”. Being introduced in 1964 it is one of the oldest programming languages that are still in use, and predates even C, Pascal and Smalltalk by several years.</p>

<p>Due to its origins as a notation, APL is very terse and uses symbols that are easily drawn, but not usually found on any computer keyboard. This terseness has given it a reputation of a write only language among people not used to reading APL programs. APL practitioners argue, that, as a single line of APL often can express algorithms that would take several pages in C-like languages, it shouldn’t be too surprising that it would take equally long to understand it.</p>

<p>APL’s array orientation allows it to work with high dimensional arrays seamlessly. High dimensional arrays are also called tensors these days. Mathematically they are a generalization of scalars, vectors and matrices into higher dimensions and tensor math is at the core of today’s deep learning frameworks. Therefore, it isn’t too much of a stretch to try to see how tensor math libraries and APL compare to each other.</p>

<h2 id="conways-game-of-life-in-apl">Conway’s Game of Life in APL</h2>
<p>Conway’s game of life is one of the many things that can be implemented with just one line of APL.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>life←{⊃1 ⍵ ∨.∧ 3 4 = +/ +/ 1 0 ¯1 ∘.⊖ 1 0 ¯1 ⌽¨ ⊂⍵}
</code></pre></div></div>

<p>APL is evaluated from right to left, so let’s start by looking at each symbol from right to left in order of their appearance. After the symbols are explained, the expression is built up from them in order to explain what is done at each step. This will help build the intuition that will be needed to reassemble it using ND4J and SameDiff.</p>

<dl>
    <dt>life←{…}</dt>
    <dd>This defines a function. As you can see, there is no explicit parameter definition.</dd>
    <dt>⍵</dt>
    <dd>This references an implicitly defined parameter. It means “the right parameter”, in this case it is the array that defines the game of life field.</dd>
    <dt>⊂</dt>
    <dd>This symbol is a nesting operation, e.g. a two-dimensional array becomes a three-dimensional array, with only a single element (itself) in this new third dimension.</dd>
    <dt>_¨</dt>
    <dd>This symbol results in the application of the function left of it (at _) to the parameters both left of it and right of it. It can be interpreted as “each”.</dd>
    <dt>⌽</dt>
    <dd>Horizontal rolling of the given array’s data (with wrap around).</dd>
    <dt>¯_</dt>
    <dd>Marks a number (at _) as negative. Due to the way how a normal - (minus) would be interpreted, there has to be an additional symbol, i.e. a high minus, to be able to differentiate the intention.</dd>
    <dt>⊖</dt>
    <dd>Vertical rolling of the given array’s data (with wrap around).</dd>
    <dt>∘._<dt>
    <dd>Outer product. Applies the given function (at _) to each combination of its left and right parameters.</dd>
    <dt>_/</dt>
    <dd>Reduce using the given function (at _) along the first dimension.</dd>
    <dt>+</dt>
    <dd>Element-wise addition. On scalars this is just simple addition</dd>
    <dt>=</dt>
    <dd>Element-wise equality comparison. </dd>
    <dt>_._</dt>
    <dd>Inner product. Uses the function given on the right to combine data along the first dimension and the function on the left to combine those results along the second dimension. They are applied to the parameters right and left of the inner product.</dd>
    <dt>∧</dt>
    <dd>Boolean AND</dd>
    <dt>∨</dt>
    <dd>Boolean OR</dd>
    <dt>⊃</dt>
    <dd>First selector, i.e. given an array, it returns the first entry in it.</dd>
</dl>

<p>With the symbol definitions out of the way, let’s look at what happens at each step. In order to make this a bit more imaginable, let’s define how the game of life field, that is going to be used, looks. This will also define the value of <code class="highlighter-rouge">⍵</code> or <code class="highlighter-rouge">field</code> for the remaining explanation.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0 0 0 0 0 0
0 0 0 1 0 0 0
0 0 0 0 1 0 0
0 0 1 1 1 0 0
0 0 0 0 0 0 0
</code></pre></div></div>

<p>The pattern on the field defines a “glider”, i.e. a structure that will move across the field, if the simulation runs for multiple steps.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>⊂⍵ 
</code></pre></div></div>

<p>By nesting the field one dimension deeper, the whole field can be addressed as a single element in APL. This is required for the next step, as it is going to roll the whole field instead of just single lines of it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 0 ¯1 ⌽¨ ⊂⍵
</code></pre></div></div>

<p>Horizontal rolling is now applied to each if the elements in the left array <code class="highlighter-rouge">1, 0, -1</code> along with the field. This results in one copy of the field being shifted to the left, one staying where it is, and one being shifted to the right.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0 0 0 0 0 0      0 0 0 0 0 0 0      0 0 0 0 0 0 0
0 0 1 0 0 0 0      0 0 0 1 0 0 0      0 0 0 0 1 0 0
0 0 0 1 0 0 0      0 0 0 0 1 0 0      0 0 0 0 0 1 0
0 1 1 1 0 0 0      0 0 1 1 1 0 0      0 0 0 1 1 1 0
0 0 0 0 0 0 0      0 0 0 0 0 0 0      0 0 0 0 0 0 0
</code></pre></div></div>

<p>Creating those shifted copies resulted in two additional arrays, each one containing the number of left and right neighbors respectively.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 0 ¯1 ∘.⊖ 1 0 ¯1 ⌽¨ ⊂⍵
</code></pre></div></div>

<p>The rules require, that all 8 neighbors are examined. The outer product is used to shift each of the newly created fields vertically, such that for each one of them a copy is created that is shifted up, stays in the same position, or is shifted down respectively.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0 1 0 0 0 0      0 0 0 1 0 0 0      0 0 0 0 1 0 0
0 0 0 1 0 0 0      0 0 0 0 1 0 0      0 0 0 0 0 1 0
0 1 1 1 0 0 0      0 0 1 1 1 0 0      0 0 0 1 1 1 0
0 0 0 0 0 0 0      0 0 0 0 0 0 0      0 0 0 0 0 0 0
0 0 0 0 0 0 0      0 0 0 0 0 0 0      0 0 0 0 0 0 0

0 0 0 0 0 0 0      0 0 0 0 0 0 0      0 0 0 0 0 0 0
0 0 1 0 0 0 0      0 0 0 1 0 0 0      0 0 0 0 1 0 0
0 0 0 1 0 0 0      0 0 0 0 1 0 0      0 0 0 0 0 1 0
0 1 1 1 0 0 0      0 0 1 1 1 0 0      0 0 0 1 1 1 0
0 0 0 0 0 0 0      0 0 0 0 0 0 0      0 0 0 0 0 0 0

0 0 0 0 0 0 0      0 0 0 0 0 0 0      0 0 0 0 0 0 0
0 0 0 0 0 0 0      0 0 0 0 0 0 0      0 0 0 0 0 0 0
0 0 1 0 0 0 0      0 0 0 1 0 0 0      0 0 0 0 1 0 0
0 0 0 1 0 0 0      0 0 0 0 1 0 0      0 0 0 0 0 1 0
0 1 1 1 0 0 0      0 0 1 1 1 0 0      0 0 0 1 1 1 0
</code></pre></div></div>
<p>This operation is essentially the same as the first, that was used to create the left and right neighbors, and that first step could have been also written as the following instead, without any difference in the result:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 0 ¯1 ∘.⌽ ⊂⍵
</code></pre></div></div>

<p>By applying those shifts into every direction, a 3x3 field of fields was created that, for each direction, contains the number of neighbors a cell has. The rules, however, do not care about the direction of a neighbor, just the count and the original state of the cell.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+/ +/ 1 0 ¯1 ∘.⊖ 1 0 ¯1 ⌽¨ ⊂⍵
</code></pre></div></div>
<p>Summing up the neighbors along both axes results in a single field containing the number of neighbors each cell has – as long as it was originally empty. If it was populated, it will be one more than that.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0 1 1 1 0 0
0 0 1 2 2 1 0
0 1 3 5 4 2 0
0 1 2 4 3 2 0
0 1 2 3 2 1 0
</code></pre></div></div>
<p>To determine which cells are populated for the next generation, the rules specify that a cell has to have either 3 neighbors if it is unpopulated, or 2 or 3 neighbors if it is populated. Because populated cells include themselves in their neighbor count, it is necessary to factor that in when applying the rules.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3 4 = +/ +/ 1 0 ¯1 ∘.⊖ 1 0 ¯1 ⌽¨ ⊂⍵
</code></pre></div></div>
<p>An element-wise comparison to 3 and 4 yields two new arrays, which contain a 1 in each place where the comparison was successful.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0 0 0 0 0 0      0 0 0 0 0 0 0
0 0 0 0 0 0 0      0 0 0 0 0 0 0
0 0 1 0 0 0 0      0 0 0 0 1 0 0
0 0 0 0 1 0 0      0 0 0 1 0 0 0
0 0 0 1 0 0 0      0 0 0 0 0 0 0
</code></pre></div></div>
<p>Comparing to 3 catches all instances of cells that either were unpopulated, and had 3 neighbors or that were populated and had 2 neighbors, which directly satisfies the first rule and part of the second rule. However, comparing to 4 yields cells that were either unpopulated and had 4 neighbors, or that were populated and had 3 neighbors. This is a bit of a problem, since the former part should not result in the population of a cell. The problem can be solved by ensuring that only the cells that were already populated are accepted from the comparison to 4.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 ⍵ ∨.∧ 3 4 = +/ +/ 1 0 ¯1 ∘.⊖ 1 0 ¯1 ⌽¨ ⊂⍵
</code></pre></div></div>

<p>That can be achieved by using a Boolean AND between the original field and the 4-comparison. As the results of the 3-comparison and the cleaned-up 4-comparison will have to be combined to yield the new field, an inner product version of the AND/OR combination is used. This in turn requires, that there is also something the 3-comparison can be AND-ed with. For this reason the parameters include a 1, which is used to ensure that the result of the 3-comparison stays unchanged. Producing an inner product like that results in a new field.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>⊃1 ⍵ ∨.∧ 3 4 = +/ +/ 1 0 ¯1 ∘.⊖ 1 0 ¯1 ⌽¨ ⊂⍵
</code></pre></div></div>
<p>And because the result is still nested too deep, it is unpacked in the very last step, to produce the outcome of one step in Conway’s game of life:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0 0 0 0 0 0
0 0 0 0 0 0 0
0 0 1 0 1 0 0
0 0 0 1 1 0 0
0 0 0 1 0 0 0
</code></pre></div></div>

<p>After looking at each step to produce the solution, let’s combine them to see the overall idea they represent.</p>

<ul>
  <li>A field of neighbors is created by shifting the original field by one step in each direction.</li>
  <li>The neighbor field is collapsed by summing up its constituents. This sum is used as the count of neighbors for each cell.</li>
  <li>A comparison applies the rules (almost) individually.</li>
  <li>The result is combined to form the field state after a simulation step.</li>
</ul>

<p>This same strategy is going to be used with ND4J and SameDiff.</p>

<h2 id="conways-game-of-life-in-java-with-nd4j">Conway’s Game of Life in Java with ND4J</h2>

<p>Using this strategy in plain Java would require a lot of looping constructs, basically taking it down to a very low level of abstraction.  But, as most of the operations are obviously tensor math, and the advent of Deep Learning has brought with it a flurry of tensor math libraries, let’s use ND4J to implement it.</p>

<p>ND4J is the computation engine behind Deeplearning4J. It is aimed to be about feature compatible with numpy. So, everything that is shown here is easily ported to Python as well. Being on the JVM it also is usable from many different languages, like Clojure, Kotlin or Scala.</p>

<p>Right at the first step, there is also the first hurdle to overcome. At the time of writing, ND4J (version 0.9.1) doesn’t have a rolling operation. However, a simple matrix multiplication will provide all the necessary rolling. The rolling effect can be achieved by first shifting an identity matrix by the wanted amount, and then multiplying it with the game field. Shifting an identity matrix, or better creating one, still requires a for loop, but it will be the only (explicit) one in this example.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="n">INDArray</span> <span class="nf">createRotationMatrix</span><span class="o">(</span><span class="kt">int</span> <span class="n">howMuch</span><span class="o">,</span> <span class="kt">int</span> <span class="n">columns</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">INDArray</span> <span class="n">rotationMatrix</span> <span class="o">=</span> <span class="n">Nd4j</span><span class="o">.</span><span class="na">zeros</span><span class="o">(</span><span class="n">columns</span><span class="o">,</span> <span class="n">columns</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">columns</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">targetIndex</span> <span class="o">=</span> <span class="o">(</span><span class="n">columns</span> <span class="o">+</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">howMuch</span><span class="o">))</span> <span class="o">%</span> <span class="n">columns</span><span class="o">;</span>
        <span class="n">rotationMatrix</span><span class="o">.</span><span class="na">putScalar</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">targetIndex</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">rotationMatrix</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>There isn’t much to this method, it follows a diagonal across the matrix that was shifted into one direction. Calculating the <code class="highlighter-rouge">targetIndex</code> just looks like this, because it allows <code class="highlighter-rouge">howMuch</code> to be a negative number, which in turn allows to easily tell the direction of the shift.</p>

<p>Next, the rotation matrices are precomputed. They can stay the same over the whole simulation, so there isn’t much of a point in recalculating them at each step.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="n">INDArray</span> <span class="n">horizontalRolling</span> <span class="o">=</span> <span class="n">Nd4j</span><span class="o">.</span><span class="na">vstack</span><span class="o">(</span>
        <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">createRotationMatrix</span><span class="o">(</span><span class="n">it</span><span class="o">,</span> <span class="n">rows</span><span class="o">)).</span><span class="na">toArray</span><span class="o">(</span><span class="n">INDArray</span><span class="o">[]::</span><span class="k">new</span><span class="o">)</span>
<span class="o">).</span><span class="na">reshape</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">rows</span><span class="o">,</span> <span class="n">rows</span><span class="o">);</span>
<span class="kd">final</span> <span class="n">INDArray</span> <span class="n">verticalRolling</span> <span class="o">=</span> <span class="n">Nd4j</span><span class="o">.</span><span class="na">vstack</span><span class="o">(</span>
        <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">createRotationMatrix</span><span class="o">(</span><span class="n">it</span><span class="o">,</span> <span class="n">columns</span><span class="o">)).</span><span class="na">toArray</span><span class="o">(</span><span class="n">INDArray</span><span class="o">[]::</span><span class="k">new</span><span class="o">)</span>
<span class="o">).</span><span class="na">reshape</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">columns</span><span class="o">,</span> <span class="n">columns</span><span class="o">);</span>
</code></pre></div></div>

<p>This is already a pretty terse implementation of creating, stacking and reshaping the rotation matrices into their required form. Yet, compared to the APL version, this certainly feels unwieldly.</p>

<p>Anyway, <code class="highlighter-rouge">horizontalRolling</code> is now a tensor of the shape <code class="highlighter-rouge">(3, rows, rows)</code> and <code class="highlighter-rouge">verticalRolling</code> is a tensor of the shape <code class="highlighter-rouge">(3, columns, columns)</code>. The rows and columns are defined by the size of the game field, and as the shift is needed across two different axes – rows and columns have to be shifted – they have to be created in a compatible shape.</p>

<p>With everything in place, the actual rolling and spreading out happens with two <code class="highlighter-rouge">tensorMmul</code> calls.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="n">INDArray</span> <span class="n">rolled</span> <span class="o">=</span> <span class="n">Nd4j</span><span class="o">.</span><span class="na">tensorMmul</span><span class="o">(</span>
        <span class="n">horizontalRolling</span><span class="o">,</span>
        <span class="n">Nd4j</span><span class="o">.</span><span class="na">tensorMmul</span><span class="o">(</span><span class="n">verticalRolling</span><span class="o">,</span> <span class="n">field</span><span class="o">,</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[][]{</span> <span class="o">{</span><span class="mi">1</span><span class="o">},</span> <span class="o">{</span><span class="mi">1</span><span class="o">}}),</span>
        <span class="k">new</span> <span class="kt">int</span><span class="o">[][]{</span> <span class="o">{</span><span class="mi">1</span><span class="o">},</span> <span class="o">{</span><span class="mi">2</span><span class="o">}}</span>
<span class="o">);</span>
</code></pre></div></div>
<p>Note, that dimensions in ND4J are 0-indexed, i.e. they start at 0 for the first dimension. The vertical rolling matrices are multiplied with the field, along their second tensor dimensions, which results in 3 fields, which are shifted in their respective directions, but also transposed.</p>

<p>Remember, that in simple matrix multiplication the order of operands matters. Because the vertical rolling tensor was used as the first operand, and the multiplication happend along the second game field dimension, the result was transposed.</p>

<p>This transpose is a requirement for rolling along the other axis. The result of this first tensorMmul call, is a tensor with the shape <code class="highlighter-rouge">(3, columns, rows)</code>. The second call once again takes the rolling tensor first, as the result should be transposed back into its original orientation. As the field input now is a 3-dimensional tensor, the matrix multiplications should now happen along the third dimension instead of the second. And it in turn results in a 4-dimensional tensor, of the shape <code class="highlighter-rouge">(3, rows, 3, columns)</code>. Inspecting it in this state would result in a rather unexpected output, as working with 4-dimensional data can be a bit daunting. But, by permuting the axes, it can be made to be easily readable again.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rolled</span><span class="o">.</span><span class="na">permute</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">));</span>
</code></pre></div></div>

<p>This is just an intermediate result, so let’s add the calculation to count all neighbors, after finishing the rotations.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="n">INDArray</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">Nd4j</span><span class="o">.</span><span class="na">tensorMmul</span><span class="o">(</span>
        <span class="n">horizontalRotation</span><span class="o">,</span>
        <span class="n">Nd4j</span><span class="o">.</span><span class="na">tensorMmul</span><span class="o">(</span><span class="n">verticalRotation</span><span class="o">,</span> <span class="n">field</span><span class="o">,</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[][]{</span> <span class="o">{</span><span class="mi">1</span><span class="o">},</span> <span class="o">{</span><span class="mi">1</span><span class="o">}}),</span>
        <span class="k">new</span> <span class="kt">int</span><span class="o">[][]{</span> <span class="o">{</span><span class="mi">1</span><span class="o">},</span> <span class="o">{</span><span class="mi">2</span><span class="o">}}</span>
<span class="o">).</span><span class="na">sum</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
</code></pre></div></div>

<p>ND4J allows to sum along multiple axes at once. So, as the axes for the neighbors run along the first and third place in its shape, they are also the axes that should be used for summing. The result is again of the original shape <code class="highlighter-rouge">(rows, columns)</code>, as the additional dimensions have been consumed by the sum calculation. <code class="highlighter-rouge">sum</code> now contains just the same neighbor counts as they were shown in the APL example.</p>

<p>All that is left to do, is now to keep only those cells that satisfy the rules.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">sum</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="na">addi</span><span class="o">(</span><span class="n">sum</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="mi">4</span><span class="o">).</span><span class="na">muli</span><span class="o">(</span><span class="n">field</span><span class="o">));</span>
</code></pre></div></div>

<p>ND4J doesn’t have Boolean AND or OR operators, so their math equivalent is used instead. First sum is compared to 4, and to keep only those cells that were originally populated, an element-wise multiplication (in-place variant) is used. Its result is then used to be added to the result of the 3-comparison (again using the in-place variant of addition). In principle multiplication and addition aren’t directly replacements for Boolean operations, but they work out like that in this case, as a multiplication of two Boolean (0/1-valued) values, will again result in a Boolean value. Addition of two Boolean matrices will result again in a Boolean matrix if their elements do not overlap. This requirement is ensured here, as a value can not be both equal to 3 and 4 at the same time.</p>

<p>The result is just the same as in the APL example, but there is no unnesting that has to be done, as the summing has reduced the number of axes even before the rules were applied.</p>

<h2 id="conways-game-of-life-in-java-with-samediff">Conway’s Game of Life in Java with SameDiff</h2>

<p>SameDiff is the upcoming graph-and-automatic-differentiation API for ND4J. It allows the definition of a computation as a graph, pretty much the same way as tensorflow or pytorch. The SameDiff API is very close to the normal ND4J API. However, it doesn’t include non-differentiable functions, as they would break the automatic differentiation.</p>

<p>A game of life implementation doesn’t require any differentiation, but it also doesn’t require any non-differentiable functions. So let’s take a look at how to implement it using SameDiff.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="n">SameDiff</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">SameDiff</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
<span class="kd">final</span> <span class="n">SDVariable</span> <span class="n">sdLifeField</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">var</span><span class="o">(</span><span class="s">"lifeField"</span><span class="o">,</span> <span class="n">field</span><span class="o">);</span>
<span class="kd">final</span> <span class="n">SDVariable</span> <span class="n">sdVerticalRotation</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">var</span><span class="o">(</span><span class="s">"⌽"</span><span class="o">,</span> <span class="n">verticalRotation</span><span class="o">);</span>
<span class="kd">final</span> <span class="n">SDVariable</span> <span class="n">sdHorizontalRotation</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">var</span><span class="o">(</span><span class="s">"⊖"</span><span class="o">,</span> <span class="n">horizontalRotation</span><span class="o">);</span>
</code></pre></div></div>

<p>First, a SameDiff instance is created in order to allow the registration of variables, and to create additional nodes that will represent further computations. Note that the field and the rotation matrices are the same as those in the plain ND4J example, as they are just plain tensors.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="n">SDVariable</span> <span class="n">sdSum</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">sum</span><span class="o">(</span>
        <span class="n">sd</span><span class="o">.</span><span class="na">tensorMmul</span><span class="o">(</span>
                <span class="n">sdHorizontalRotation</span><span class="o">,</span>
                <span class="n">sd</span><span class="o">.</span><span class="na">tensorMmul</span><span class="o">(</span><span class="n">sdVerticalRotation</span><span class="o">,</span> <span class="n">sdLifeField</span><span class="o">,</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[][]{</span> <span class="o">{</span><span class="mi">1</span><span class="o">},</span> <span class="o">{</span><span class="mi">1</span><span class="o">}}),</span>
                <span class="k">new</span> <span class="kt">int</span><span class="o">[][]{</span> <span class="o">{</span><span class="mi">1</span><span class="o">},</span> <span class="o">{</span><span class="mi">2</span><span class="o">}}</span>
        <span class="o">),</span>
        <span class="mi">0</span><span class="o">,</span> <span class="mi">2</span>
    <span class="o">);</span>

<span class="kd">final</span> <span class="n">SDVariable</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">sdSum</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="na">addi</span><span class="o">(</span><span class="n">sd</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">sdSum</span><span class="o">,</span> <span class="mi">4</span><span class="o">).</span><span class="na">muli</span><span class="o">(</span><span class="n">sdLifeField</span><span class="o">));</span>
</code></pre></div></div>

<p>Again, no surprises while setting up the computation, it looks almost the same as the plain ND4J version, with the only difference being that – at the time of writing – SDVariable instances don’t have <code class="highlighter-rouge">.sum</code> or <code class="highlighter-rouge">.eq</code> methods yet, so they have to be used from the SameDiff instance instead.</p>

<p>As this concludes the definition of the computation, it is now time to actually execute it and get the result.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sd</span><span class="o">.</span><span class="na">exec</span><span class="o">();</span>

<span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">getArr</span><span class="o">();</span>
</code></pre></div></div>
<p>Still, no surprises here. The graph is executed and the result variable is read to get its value.</p>

<p>This is a very basic example of using SameDiff. It would be possible, for example, to define the game field with a placeholder variable, that only knows about the shape of its content. This would allow the reuse of the same graph for multiple steps of the simulation. Also, game of life is at best an edge case for SameDiff use, as it is designed with machine learning in mind.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This post has set out to implement Conway’s game of life using tensor math. In order to provide an intuition on how to do that, it introduced APL, which in itself can be considered as an appropriate vessel for doing tensor math. The single-line APL expression for the calculation of the next step in Conway’s game of life was explained and this explanation in turn was used to motivate the implementation using Java and the tensor math library ND4J and SameDiff.</p>

<p>If you’d like to play around with APL, you can find an online version at <a href="http://tryapl.org/">tryapl.org</a>, where you will also find a more detailed walk through of this particular implementation of Conway’s game of life. If you’d like to know about the reasoning behind APL and notation as a tool of thought, you might also be interested in the <a href="http://www.jsoftware.com/papers/tot.htm">turing award acceptance speech / paper by Kenneth E. Iverson</a>.</p>

<p>You can find more information about ND4J at <a href="https://nd4j.org/userguide">nd4j.org/userguide</a>. If you’d like to play around with SameDiff, be warned that, at the time of writing, it wasn’t released yet, but you can get it by using a SNAPSHOT version of ND4J – and as it isn’t released yet, you will also have trouble finding documentation on it, but there are some usage examples you can find in the <a href="https://github.com/deeplearning4j/nd4j/blob/master/nd4j-backends/nd4j-tests/src/test/java/org/nd4j/autodiff/samediff/SameDiffTests.java">SameDiffTests</a>.</p>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="https://www.dubs.tech/tags#apl" title="Pages tagged apl" class="tag"><span class="term">apl</span></a><a href="https://www.dubs.tech/tags#nd4j" title="Pages tagged nd4j" class="tag"><span class="term">nd4j</span></a><a href="https://www.dubs.tech/tags#samediff" title="Pages tagged samediff" class="tag"><span class="term">samediff</span></a></span>
        
        <span class="author vcard"><span class="fn">Paul Dubs</span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://www.dubs.tech/blog/game-of-life-apl-nd4j-samediff/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=https://www.dubs.tech/blog/game-of-life-apl-nd4j-samediff/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=https://www.dubs.tech/blog/game-of-life-apl-nd4j-samediff/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->

      </footer>
    </div><!-- /.entry-content -->
    <div class="read-more">
  <div class="read-more-header">
    <a href="/about" class="read-more-btn">About the Author</a>
  </div><!-- /.read-more-header -->
  <div class="read-more-content author-info">
    <h3>Paul Dubs</h3>
    <div class="author-container">
      <img class="author-img" src="https://www.dubs.tech/images/avatar.jpg" alt="Paul Dubs" />
      <div class="author-bio">Professional software developer for over 12 years. Passionate about creating maintainable solutions and helping people to learn.</div>
    </div>
    <div class="author-share">
      <ul class="list-inline social-buttons">
        
          <li><a href="https://github.com/treo" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
        
          <li><a href="https://www.linkedin.com/in/paul-dubs" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
        
      </ul>
      
        <a aria-label="Follow @treo on GitHub" data-style="mega" href="https://github.com/treo" class="github-button">Follow @treo</a>
      
      <br>
      
        <a href="https://twitter.com/dot_treo" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @dot_treo</a>
      
    </div>
  </div>
</div>

    
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="https://www.dubs.tech/guides/maven-essentials/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="https://www.dubs.tech/blog/benchmarking-nd4j-and-neanderthal-2/" title="Benchmarking ND4J and Neanderthal – Part 2">Benchmarking ND4J and Neanderthal – Part 2</a></h3>
      <p>A fair comparison between chained matrix multiplication with ND4J and Neanderthal. <a href="https://www.dubs.tech/blog/benchmarking-nd4j-and-neanderthal-2/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="https://www.dubs.tech/blog/benchmarking-nd4j-and-neanderthal/" title="Benchmarking ND4J and Neanderthal">Benchmarking ND4J and Neanderthal</a></h4>
        <span>Published on June 26, 2018</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="https://www.dubs.tech/guides/maven-essentials/" title="Maven: Essentials">Maven: Essentials</a></h4>
        <span>Published on February 05, 2018</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="https://www.dubs.tech/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="https://www.dubs.tech/assets/js/scripts.min.js"></script>
<script type="text/javascript" async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
<script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>










<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2018 Paul Dubs.</span>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
