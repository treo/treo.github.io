<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Benchmarking ND4J and Neanderthal &#8211; dubs·tech</title>
<meta name="description" content="Comparing the overhead of the two fastest matrix math libraries on the JVM.">
<meta name="keywords" content="nd4j">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@dot_treo">
<meta name="twitter:creator" content="@dot_treo">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Benchmarking ND4J and Neanderthal">
<meta property="og:description" content="Comparing the overhead of the two fastest matrix math libraries on the JVM.">
<meta property="og:url" content="https://www.dubs.tech/blog/benchmarking-nd4j-and-neanderthal/">
<meta property="og:site_name" content="dubs·tech">
<meta property="og:image" content="https://www.dubs.tech/images/images/logo.png">

<meta name="google-site-verification" content="n-ohWAcyARq2F3YAT0UtBa3gh0fluEoFMmHupOCXOvs">



<link rel="canonical" href="https://www.dubs.tech/blog/benchmarking-nd4j-and-neanderthal/">
<link href="https://www.dubs.tech/feed.xml" type="application/atom+xml" rel="alternate" title="dubs·tech Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="https://www.dubs.tech/assets/css/main.css">
<link rel="stylesheet" href="https://www.dubs.tech/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="https://www.dubs.tech/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script type="text/javascript" src="https://www.dubs.tech/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://www.dubs.tech/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://www.dubs.tech/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://www.dubs.tech/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.dubs.tech/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.dubs.tech/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.dubs.tech/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><h2><i class="fa fa-bars"></i></h2></a></li>
      <li class="header-item-title">
        <a href="https://www.dubs.tech/">
          
            <img class="logo" src="https://www.dubs.tech/images/logo.png" alt="dubs·tech">
          
          <a href="https://www.dubs.tech/" class="title"> dubs·tech</a>
        </a>
      </li>
      
        
        

        
          <li class="header-item "><a href="https://www.dubs.tech/categories"><h3>Categories</h3></a>
            <ul class="header-submenu">
              
                
                  <li class="sub-item"><a href="https://www.dubs.tech/categories/#blog">blog</a></li>
              
                
                  <li class="sub-item"><a href="https://www.dubs.tech/categories/#guides">guides</a></li>
              
            </ul>
          </li>
        
      
        
        

        
            
                <li class="header-item "><a href="https://www.dubs.tech/tags"><h3>Tags</h3></a></li>
            
        
      
        
        

        
            
                <li class="header-item "><a href="https://www.dubs.tech/"><h3>Home</h3></a></li>
            
        
      
      <li class="header-item"><a href="https://www.dubs.tech/search"><h3><i class="fa fa-search"></i></h3></a></li>
    </ul>
  </div>
<div class="entry-header">
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Benchmarking ND4J and Neanderthal</h1>
      
        <h2><span class="entry-date date published updated"><time datetime="2018-06-26T13:17:10+02:00">June 26, 2018</time></span></h2>
      

      
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~11 minutes
        </p><!-- /.entry-reading-time -->
      
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->


<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="https://www.dubs.tech/"><h3>Home</h3></a></li>
      
    
      
        <li><a href="https://www.dubs.tech/tags"><h3>Tags</h3></a></li>
      
    
      
        <li><a href="https://www.dubs.tech/categories"><h3>Categories</h3></a>
          <ul>
            
              
                <li><a href="https://www.dubs.tech/categories/#blog">blog</a></li>
            
              
                <li><a href="https://www.dubs.tech/categories/#guides">guides</a></li>
            
          </ul>
        </li>
      
    
  </ul>
</nav>

<div id="main" role="main">
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">Benchmarking ND4J and Neanderthal</h1>
      <p><a href="https://nd4j.org/">ND4J</a> and <a href="https://neanderthal.uncomplicate.org/">Neanderthal</a> are both libraries for fast matrix math on the JVM. ND4J targets Java users, while Neanderthal is aimed at Clojure users. Due to Clojure’s excellent Java Interop, it is quite easy to use ND4J in Clojure as well — even though it doesn’t provide an idiomatic Clojure API out of the box.</p>

<p>Dragan Djuric, the creator of Neanderthal, has recently <a href="https://dragan.rocks/articles/18/Neanderthal-vs-ND4J-vol1">conducted a micro-benchmark of both ND4J and Neanderthal</a>. The operation under test is matrix multiplication, in particular, calling GEMM from <a href="https://software.intel.com/en-us/mkl">Intel’s MKL</a> library. The results have been quite unexpected, since both libraries shouldn’t do that much at that point, they basically pass on the call to MKL.</p>

<p>When the results had shown that Neanderthal is 24 times faster with the smallest input of a 4x4 matrix, and still 20% faster at 4096x4096, it made me curious to what is going on. Especially since his ND4J code is based on <a href="https://github.com/treo/benchmarking_nd4j/blob/master/src/main/java/com/example/neanderthal/NeanderthalComparison_2x2.java">my original benchmarks</a>.</p>

<p>When I originally compared ND4J and Neanderthal matrix multiplication speeds, the results left me wondering, since ND4J was slower at small sizes, yet faster at larger sizes. For this reason I never actually published any numbers. I originally based my comparison on <a href="https://github.com/uncomplicate/neanderthal/blob/1fe9d82ecd5d4ee4d7b19d9dbf8105ede9b5e83b/examples/benchmarks/src/benchmarks/core.clj">Dragan’s benchmark code</a>, but I didn’t notice that doubles were used there instead of floats. His new benchmark has cleared this confusion, and I’m glad that Dragan has shared both code and results.</p>

<p>In this post I try to validate Dragan’s results, show the detail that changes the numbers considerably, and rerun the benchmark after some additional optimizations have been added to ND4J.</p>

<!--more-->

<h1 id="apple-to-apple-comparison-changing-some-code">Apple to Apple comparison: Changing some code</h1>

<p>In Dragan’s benchmark, Neanderthal wins with by a large margin. So let’s take a look at the code to see if there is anything we can do to improve ND4J’s performance. Dragan uses this code to run the benchmark for nd4j:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">bench-nd4j-mmuli-float</span><span class="w"> </span><span class="p">[</span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">n</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/rand</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w">
        </span><span class="n">m2</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/rand</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
        </span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/createUninitialized</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">n</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">quick-bench</span><span class="w">
     </span><span class="p">(</span><span class="nf">do</span><span class="w"> </span><span class="p">(</span><span class="nf">.mmuli</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w">
         </span><span class="n">true</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>And while this looks correct, it actually has an issue. In ND4J arrays are C-ordered by default, i.e. their memory layout is as if you were to allocate an array in C. Yet, GEMM returns its result in F-order, i.e. with a memory layout that you would get if you allocated an array in Fortran. The difference is whether your two dimensional array is organized as <code class="highlighter-rouge">[rows][columns]</code> or <code class="highlighter-rouge">[columns][rows]</code>. If you pass a C-ordered array to take the result here, ND4J will notice this, create a new array in F-order, and then transfer the results to the original result array. All of this takes time, and especially in a micro-benchmark case where this is called thousands of times per second, memory allocation can become quite the bottleneck.</p>

<p>After changing the code to use F-ordered arrays it looked like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">bench-nd4j-mmuli-float</span><span class="w"> </span><span class="p">[</span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">n</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/rand</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w">
        </span><span class="n">m2</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/rand</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
        </span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/createUninitialized</span><span class="w"> </span><span class="p">(</span><span class="nf">int-array</span><span class="w"> </span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="n">n</span><span class="p">])</span><span class="w"> </span><span class="sc">\f</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">quick-bench</span><span class="w">
     </span><span class="p">(</span><span class="nf">do</span><span class="w"> </span><span class="p">(</span><span class="nf">.mmuli</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w">
         </span><span class="n">true</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>And when I ran it with a tiny matrix, it was a lot faster – 5 times faster – but it was also still about 2 times slower than running the same code from Java directly in my JMH benchmark suite. I’m not sure what is the cause for this. But, since we want to actually compare apples to apples, I decided to change the call itself. <code class="highlighter-rouge">INDArray.mmuli</code> has some additional checks to support some not-actually matrix multiplication use-cases.</p>

<p>After checking Neanderthal’s source code to see if it would still be a fair comparison, I moved on to using <code class="highlighter-rouge">Nd4j.gemm</code> directly. It is the closest in actual functionality to Neanderthal’s <code class="highlighter-rouge">mm!</code> call. Both of them do some basic parameter checking before passing them on to MKL. In the case of ND4J it also enforces the ordering, as explained earlier. The following is the benchmark code that I ended up using:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">bench-nd4j-gemm-float</span><span class="w"> </span><span class="p">[</span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">^</span><span class="nb">long</span><span class="w"> </span><span class="n">n</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/rand</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w">
        </span><span class="n">m2</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/rand</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
        </span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/createUninitialized</span><span class="w"> </span><span class="p">(</span><span class="nf">int-array</span><span class="w"> </span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="n">n</span><span class="p">])</span><span class="w"> </span><span class="sc">\f</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">quick-bench</span><span class="w">
     </span><span class="p">(</span><span class="nf">do</span><span class="w"> </span><span class="p">(</span><span class="nf">Nd4j/gemm</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="o">^</span><span class="n">INDArray</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w">
         </span><span class="n">true</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>And it turns out that this way of calling GEMM appears to be exactly as fast when called from JMH and from <a href="https://github.com/hugoduncan/criterium/">Criterium</a> (the benchmarking library that provides us with the quick-bench method).</p>

<p>I’ve also created a <a href="https://github.com/uncomplicate/neanderthal/pull/46">pull request for Neanderthal</a>, so the benchmark code there is closer to an apple to apple comparison.</p>

<h1 id="first-benchmarking-results">First benchmarking results</h1>

<p>Aside from this modification, I use the original benchmark code by Dragan, using Criterium as the benchmarking library and Neanderthal 0.19 and ND4J 1.0.0-beta. My computer is equipped with an Intel Core i7-6700K, running at 4.6GHz, 32GB RAM running at 2933MHz and uses Windows 10 as the operating system.</p>

<p>Since Windows likes doing Windows things in the background, I’ve ran the benchmark 10 times for each matrix size, alternating between Neanderthal and ND4J, and averaged the numbers afterwards.</p>

<table rules="groups">
  <thead>
    <tr>
      <th style="text-align: left">Library</th>
      <th style="text-align: right">Size</th>
      <th style="text-align: right">Time per Op (ns)</th>
      <th style="text-align: right">Diff vs Neanderthal</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">2x2</td>
      <td style="text-align: right">595</td>
      <td style="text-align: right">166 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">2x2</td>
      <td style="text-align: right">223</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">4x4</td>
      <td style="text-align: right">598</td>
      <td style="text-align: right">163 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">4x4</td>
      <td style="text-align: right">227</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">8x8</td>
      <td style="text-align: right">612</td>
      <td style="text-align: right">156 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">8x8</td>
      <td style="text-align: right">239</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">16x16</td>
      <td style="text-align: right">715</td>
      <td style="text-align: right">134 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">16x16</td>
      <td style="text-align: right">305</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">32x32</td>
      <td style="text-align: right">1312</td>
      <td style="text-align: right">69 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">32x32</td>
      <td style="text-align: right">774</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">64x64</td>
      <td style="text-align: right">4519</td>
      <td style="text-align: right">40 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">64x64</td>
      <td style="text-align: right">3208</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">128x128</td>
      <td style="text-align: right">19288</td>
      <td style="text-align: right">18 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">128x128</td>
      <td style="text-align: right">16285</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">256x256</td>
      <td style="text-align: right">120588</td>
      <td style="text-align: right">1 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">256x256</td>
      <td style="text-align: right">118917</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">512x512</td>
      <td style="text-align: right">907426</td>
      <td style="text-align: right">3 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">512x512</td>
      <td style="text-align: right">880935</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">1024x1024</td>
      <td style="text-align: right">7119631</td>
      <td style="text-align: right">5 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">1024x1024</td>
      <td style="text-align: right">6803776</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">2048x2048</td>
      <td style="text-align: right">53491781</td>
      <td style="text-align: right">7 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">2048x2048</td>
      <td style="text-align: right">49876333</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">4096x4096</td>
      <td style="text-align: right">397762380</td>
      <td style="text-align: right">-8 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">4096x4096</td>
      <td style="text-align: right">437036465</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">8192x8192</td>
      <td style="text-align: right">3480873900</td>
      <td style="text-align: right">0 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">8192x8192</td>
      <td style="text-align: right">3452838100</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
</table>

<p>The table shows that after a matrix size of 256x256 the performance of both libraries is within the margin of error of each other. But when using smaller matrices, it is apparent that Neanderthal indeed has a lower overhead. The difference isn’t as high as Dragan found, and in absolute terms about 350ns to 400ns may seem insignificant, yet we should still try to get it down to the bare minimum. This is even more true, if you consider that for those tiny matrices where this overhead is twice the time that Neanderthal needs.</p>

<h1 id="investigating-the-source-of-added-overhead">Investigating the source of added overhead</h1>

<p>In order to find out where some of that latency was hiding, I used an even lower level way of calling GEMM from Java. Since JavaCPP provides the bindings to the lower level libraries, and those bindings are public static methods, they can be also used directly. So, in order to find out if the source of this additional latency is on the Java side of things or on the native side, I used that call directly. The result: 231 ± 4 ns per operation, which looks very much like it is within the margin of error of Neanderthal. The additional latency has to be on the Java side.</p>

<p>With those numbers in hand <a href="https://github.com/raver119">@raver119</a> has taken to the code, and started investigating what may be the cause of it. He found <a href="https://github.com/deeplearning4j/deeplearning4j/commit/70dc867fe8e1cc21ad47473d5c99517537286728">one reason</a>, and the change has already landed on master, and is therefore available on SNAPSHOT releases.</p>

<h1 id="repeating-the-benchmark">Repeating the Benchmark</h1>

<p>With that change in place, I wanted to repeat the benchmark. Now something weird happened: Using the criterium based benchmark code, now both Neanderthal and ND4J were 2 times slower than before. I changed back to the old version to make sure it wasn’t due to the change in ND4J, but it stayed this way.</p>

<p>Interestingly, my own benchmarks with JMH didn’t suffer from this, so I set out to port the Clojure code to Java. Thus using the Clojure to Java Interop into this direction for the first time. While the direction Java to Clojure is quite a breeze, the other way around is pretty ugly as long as there is no specialized API around it. Anyway, I marched on, and figured out how to do it (for more comments on this see <a href="#oddities">Oddities</a>).</p>

<p>Using the numbers that I originally collected, I validated that Neanderthal was still as fast as it was using the criterium based benchmark. The following table shows the results using JMH as the benchmarking framework, Neanderthal 0.19 and ND4J 1.0.0-SNAPSHOT.</p>

<table rules="groups">
  <thead>
    <tr>
      <th style="text-align: left">Library</th>
      <th style="text-align: right">Size</th>
      <th style="text-align: right">Time per Op (ns)</th>
      <th style="text-align: right">Diff vs Neanderthal</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">2x2</td>
      <td style="text-align: right">309</td>
      <td style="text-align: right">32 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">2x2</td>
      <td style="text-align: right">234</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">4x4</td>
      <td style="text-align: right">319</td>
      <td style="text-align: right">31 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">4x4</td>
      <td style="text-align: right">243</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">8x8</td>
      <td style="text-align: right">322</td>
      <td style="text-align: right">29 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">8x8</td>
      <td style="text-align: right">249</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">16x16</td>
      <td style="text-align: right">420</td>
      <td style="text-align: right">31 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">16x16</td>
      <td style="text-align: right">320</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">32x32</td>
      <td style="text-align: right">1005</td>
      <td style="text-align: right">5 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">32x32</td>
      <td style="text-align: right">958</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">64x64</td>
      <td style="text-align: right">3786</td>
      <td style="text-align: right">29 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">64x64</td>
      <td style="text-align: right">2925</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">128x128</td>
      <td style="text-align: right">18816</td>
      <td style="text-align: right">19 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">128x128</td>
      <td style="text-align: right">16683</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">256x256</td>
      <td style="text-align: right">104342</td>
      <td style="text-align: right">-3 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">256x256</td>
      <td style="text-align: right">108048</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">512x512</td>
      <td style="text-align: right">775124</td>
      <td style="text-align: right">1 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">512x512</td>
      <td style="text-align: right">765648</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">1024x1024</td>
      <td style="text-align: right">6534687</td>
      <td style="text-align: right">8 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">1024x1024</td>
      <td style="text-align: right">6031096</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">2048x2048</td>
      <td style="text-align: right">44854846</td>
      <td style="text-align: right">6 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">2048x2048</td>
      <td style="text-align: right">42211136</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">4096x4096</td>
      <td style="text-align: right">317275196</td>
      <td style="text-align: right">-1 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">4096x4096</td>
      <td style="text-align: right">319272117</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">ND4J</td>
      <td style="text-align: right">8192x8192</td>
      <td style="text-align: right">2783549850</td>
      <td style="text-align: right">8 %</td>
    </tr>
    <tr>
      <td style="text-align: left">Neanderthal</td>
      <td style="text-align: right">8192x8192</td>
      <td style="text-align: right">2571527782</td>
      <td style="text-align: right"> </td>
    </tr>
  </tbody>
</table>

<p>We can see that especially for very small matrices the difference has closed a lot. Neanderthal still wins here though and is still about 30% faster when the overhead dominates the actual calculation. So, we still have to look for ways to reduce our overall overhead some more.</p>

<p>For larger sizes, as could already be seen in the first benchmark, the difference isn’t that clear. During preparation of this post, I’ve seen the numbers fluctuate for about 10% in any direction, so everything within 10% of each other is a draw for me at the moment.</p>

<h1 id="oddities">Oddities</h1>

<p>While preparing this blog post I ran into several odd behaviors.</p>

<p>One is the criterium benchmark seemingly getting slower over time, even as I’ve restarted JVMs. Only after several reboots it went back to normal behavior. I’m stumped as to why that may happen.</p>

<p>Then there were those 10% swings for both libraries, even when a benchmark was run for many interations. I may run a benchmark for quite a few iterations and get a number on which JMH is rather certain, showing a pretty low standard deviation, but once I repeat it I get a swing in either direction, again with a reported low standard deviation.</p>

<p>I guess that increasing the iteration time could reduce those swings a lot. But, given that I don’t want to compromise on some of the other options (i.e. using at least 2 forks, and using at least 10 benchmark iterations), using 1 minute for each benchmark would require over 8 hours of benchmarking. And since I’ve seen irregularities even with that on the larger sizes as well, I’d probably have to up that to 5 minutes, which would take almost two whole days to finish the benchmark for all sizes. Therefore, I’ll be content with saying that everything within 10% of each other is close enough to be considered a draw.</p>

<p>And I’m not even sure I could run the whole benchmark for that long. Originally, I wanted to use at least 10 seconds for each benchmark iteration, but, my computer crashes during the Neanderthal 64x64 benchmark if it runs for longer than 5 seconds. I guess it is due to the mild overclock, since it seems to cope better once I go back to stock speeds, but I didn’t have any issue with that using ND4J on that same size, and during the last 3 years that I’ve had this computer.</p>

<p>I found yet another odditiy while trying to make Neanderthal work in JMH. I ran into the issue that Clojure couldn’t cast an AOT compiled version of its pretty printer into itself, and the results that google spit out didn’t really help with the issue. In the end, I simply removed the AOT compiled version from the uberjar with a maven configuration option and that resolved the issue.</p>

<h1 id="repeating-my-benchmarks">Repeating my benchmarks</h1>

<p>I’ve updated <a href="https://github.com/treo/benchmarking_nd4j">my benchmarking_nd4j repository</a> to contain everything that I’ve used for the second round of benchmarks. If you want to repeat them on your own machine, you can clone the repository:</p>

<p><code class="highlighter-rouge">git clone https://github.com/treo/benchmarking_nd4j.git</code></p>

<p>Build an Uberjar:</p>

<p><code class="highlighter-rouge">mvn clean package</code></p>

<p>And run it:</p>

<p><code class="highlighter-rouge">java -jar target/benchmarks.jar -f2 -i10 -wi 2 Neanderthal</code></p>

<p>This invocation will use 2 forks, 10 iterations per fork and 2 warm up iterations. It uses the default iteration time of just one second. By passing a name fragment, JMH will only start the benchmarks that start with that name. If you leave it out, it will run all benchmarks within the repository, which can take quite a considerable amount of time.</p>

<p>For more options you can run it as follows to print its help screen:</p>

<p><code class="highlighter-rouge">java -jar target/benchmarks.jar -h</code></p>

<p>Also, please notice, that since I’m using a SNAPSHOT version here, I’m not using the ND4J -platform artifact. For this reason, it will not work, if you upload the jar to a machine using a different operating system or CPU architecture.</p>

<h1 id="conclusion">Conclusion</h1>

<p>I’m very grateful for Dragan to have conducted his benchmarks on both ND4J and Neanderthal. The investigation that it started has already borne fruit: we have already found and fixed some issues, as you can see in the second benchmark.</p>

<p>And while the difference even in the first benchmark wasn’t as dramatic once the result array ordering is properly set, it has still shown that Neanderthal indeed has a very low overhead and that to get the full performance out of ND4J you should know what you are doing.</p>

<p>There are still some points where ND4J could lose some more overhead, and we are investigating them, so I’m looking forward to repeating these benchmarks as soon as we have them figured out as well.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="https://www.dubs.tech/tags#nd4j" title="Pages tagged nd4j" class="tag"><span class="term">nd4j</span></a></span>
        
        <span class="author vcard"><span class="fn">Paul Dubs</span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://www.dubs.tech/blog/benchmarking-nd4j-and-neanderthal/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=https://www.dubs.tech/blog/benchmarking-nd4j-and-neanderthal/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=https://www.dubs.tech/blog/benchmarking-nd4j-and-neanderthal/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->

      </footer>
    </div><!-- /.entry-content -->
    <div class="read-more">
  <div class="read-more-header">
    <a href="/about" class="read-more-btn">About the Author</a>
  </div><!-- /.read-more-header -->
  <div class="read-more-content author-info">
    <h3>Paul Dubs</h3>
    <div class="author-container">
      <img class="author-img" src="https://www.dubs.tech/images/avatar.jpg" alt="Paul Dubs" />
      <div class="author-bio">Professional software developer for over 12 years. Passionate about creating maintainable solutions and helping people to learn.</div>
    </div>
    <div class="author-share">
      <ul class="list-inline social-buttons">
        
          <li><a href="https://github.com/treo" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
        
          <li><a href="https://www.linkedin.com/in/paul-dubs" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
        
      </ul>
      
        <a aria-label="Follow @treo on GitHub" data-style="mega" href="https://github.com/treo" class="github-button">Follow @treo</a>
      
      <br>
      
        <a href="https://twitter.com/dot_treo" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @dot_treo</a>
      
    </div>
  </div>
</div>

    
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="https://www.dubs.tech/blog/game-of-life-apl-nd4j-samediff/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="https://www.dubs.tech/blog/game-of-life-apl-nd4j-samediff/" title="Implementing Conway’s Game of Life with Tensor Math">Implementing Conway’s Game of Life with Tensor Math</a></h3>
      <p>Exploring the similarities between APL and tensor math libraries. <a href="https://www.dubs.tech/blog/game-of-life-apl-nd4j-samediff/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="https://www.dubs.tech/guides/maven-essentials/" title="Maven: Essentials">Maven: Essentials</a></h4>
        <span>Published on February 05, 2018</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="https://www.dubs.tech/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="https://www.dubs.tech/assets/js/scripts.min.js"></script>
<script type="text/javascript" async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
<script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>










<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2018 Paul Dubs.</span>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
